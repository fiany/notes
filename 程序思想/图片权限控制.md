# 关于图片权限控制的思考

## 问题出现

我们所有的web项目都会涉及到图片的内容，之前的项目类似于网上商城，所使用到的图片都是直接使用nginx做转发，指向图片的根路径，而现在的项目中出现了一些隐私性的图片，这些图片就需要做些权限控制了。

## 目前的解决方案

在之前所做的第一个项目中，我们把所有的图片存入了数据库中，前后端传输转为base64编码，因为这个项目不存在外部可以访问的内容，所以这样做看似没有问题，但是这样有一个问题，传送给前端的时候我们只给了图片id，前台需要的时候调接口去下载，如果是一个列表，前台会多次请求下载图片，感觉也是不妥，而且图片都存入数据库，也不方便后续查看，较为复杂，后面的一个项目中，隐私类的图片存入数据库，外部可以查看的图片存入ftp,使用nginx做静态资源转发，但这里有两个图片上传接口，貌似是有点复杂了。

## 一点构想

目前我现在有一个想法，所有的图片统一调用一个图片上传接口，form表单形式提交的图片，图片存入ftp中，然后生成一个图片编码和图片ftp的url,然后生成图片权限控制信息(具体如何控制权限，后面再进行思考)，再生成一个可以下载图片的url返回给前端，再添加一个图片下载接口，这个接口使用get请求，可以携带header信息，通过header信息我们可以判断用户是否有访问权限，如果无权限可以返回一个默认图片，这个get请求的url就是前面提到的返回给前端的url，为什么使用get请求呢，因为这个可以直接嵌入标签中，网页也可以直接访问，而不需要再单独写业务逻辑。感觉这个方案相比之前会有很多提升。

## 补充

tomcat容器不适合做静态资源服务器，静态资源的请求量很大，而tomcat容器可创建的线程数量有限，所有图片资源还是比较适合用nginx做转发，至于如何限制图片不能被所有人访问，暂时想到的想法是随机生成图片地址，加长图片地址长度，图片地址只是由数据库返回，外面拿不到，也就无法拿到图片，间接做成了图片的权限控制。

## 继续改进

通过nginx访问图片视频资源固然比通过tomcat访问资源速度要快而且节省资源。但是这个又有一个问题，服务器资源固然是节省了，访问图片视频所占用的带宽还是那么多。通常在应用服务器中，带宽主要给前后台交互应用数据，如果图片视频资源占用了大量的带宽，那我们的应用访问速度就会大大降低，所以最好还是将图片视频资源独立出来。这时候如果需要选择服务那我们进去找应用提供商就可以了，如阿里云腾讯云这类。像阿里云上面有oss对象存储可以解决这类问题。

## 后记

通常我们在做服务器应用的时候，如果没有好的解决办法，直接咨询应用提供商客服，毕竟他们似乎提供服务的。相对来说会比我们自己写一个节省不少时间的，毕竟免费的才是最贵的嘛。

